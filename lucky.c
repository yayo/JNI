#include <jni.h>
#include <stdint.h>
#include <stdio.h>
#include <assert.h>
#include <time.h>
#include <openssl/rand.h>
#include "lucky.h"

static const uint32_t crc32tab[] = {
 0x00000000UL, 0x77073096UL, 0xee0e612cUL, 0x990951baUL,
 0x076dc419UL, 0x706af48fUL, 0xe963a535UL, 0x9e6495a3UL,
 0x0edb8832UL, 0x79dcb8a4UL, 0xe0d5e91eUL, 0x97d2d988UL,
 0x09b64c2bUL, 0x7eb17cbdUL, 0xe7b82d07UL, 0x90bf1d91UL,
 0x1db71064UL, 0x6ab020f2UL, 0xf3b97148UL, 0x84be41deUL,
 0x1adad47dUL, 0x6ddde4ebUL, 0xf4d4b551UL, 0x83d385c7UL,
 0x136c9856UL, 0x646ba8c0UL, 0xfd62f97aUL, 0x8a65c9ecUL,
 0x14015c4fUL, 0x63066cd9UL, 0xfa0f3d63UL, 0x8d080df5UL,
 0x3b6e20c8UL, 0x4c69105eUL, 0xd56041e4UL, 0xa2677172UL,
 0x3c03e4d1UL, 0x4b04d447UL, 0xd20d85fdUL, 0xa50ab56bUL,
 0x35b5a8faUL, 0x42b2986cUL, 0xdbbbc9d6UL, 0xacbcf940UL,
 0x32d86ce3UL, 0x45df5c75UL, 0xdcd60dcfUL, 0xabd13d59UL,
 0x26d930acUL, 0x51de003aUL, 0xc8d75180UL, 0xbfd06116UL,
 0x21b4f4b5UL, 0x56b3c423UL, 0xcfba9599UL, 0xb8bda50fUL,
 0x2802b89eUL, 0x5f058808UL, 0xc60cd9b2UL, 0xb10be924UL,
 0x2f6f7c87UL, 0x58684c11UL, 0xc1611dabUL, 0xb6662d3dUL,
 0x76dc4190UL, 0x01db7106UL, 0x98d220bcUL, 0xefd5102aUL,
 0x71b18589UL, 0x06b6b51fUL, 0x9fbfe4a5UL, 0xe8b8d433UL,
 0x7807c9a2UL, 0x0f00f934UL, 0x9609a88eUL, 0xe10e9818UL,
 0x7f6a0dbbUL, 0x086d3d2dUL, 0x91646c97UL, 0xe6635c01UL,
 0x6b6b51f4UL, 0x1c6c6162UL, 0x856530d8UL, 0xf262004eUL,
 0x6c0695edUL, 0x1b01a57bUL, 0x8208f4c1UL, 0xf50fc457UL,
 0x65b0d9c6UL, 0x12b7e950UL, 0x8bbeb8eaUL, 0xfcb9887cUL,
 0x62dd1ddfUL, 0x15da2d49UL, 0x8cd37cf3UL, 0xfbd44c65UL,
 0x4db26158UL, 0x3ab551ceUL, 0xa3bc0074UL, 0xd4bb30e2UL,
 0x4adfa541UL, 0x3dd895d7UL, 0xa4d1c46dUL, 0xd3d6f4fbUL,
 0x4369e96aUL, 0x346ed9fcUL, 0xad678846UL, 0xda60b8d0UL,
 0x44042d73UL, 0x33031de5UL, 0xaa0a4c5fUL, 0xdd0d7cc9UL,
 0x5005713cUL, 0x270241aaUL, 0xbe0b1010UL, 0xc90c2086UL,
 0x5768b525UL, 0x206f85b3UL, 0xb966d409UL, 0xce61e49fUL,
 0x5edef90eUL, 0x29d9c998UL, 0xb0d09822UL, 0xc7d7a8b4UL,
 0x59b33d17UL, 0x2eb40d81UL, 0xb7bd5c3bUL, 0xc0ba6cadUL,
 0xedb88320UL, 0x9abfb3b6UL, 0x03b6e20cUL, 0x74b1d29aUL,
 0xead54739UL, 0x9dd277afUL, 0x04db2615UL, 0x73dc1683UL,
 0xe3630b12UL, 0x94643b84UL, 0x0d6d6a3eUL, 0x7a6a5aa8UL,
 0xe40ecf0bUL, 0x9309ff9dUL, 0x0a00ae27UL, 0x7d079eb1UL,
 0xf00f9344UL, 0x8708a3d2UL, 0x1e01f268UL, 0x6906c2feUL,
 0xf762575dUL, 0x806567cbUL, 0x196c3671UL, 0x6e6b06e7UL,
 0xfed41b76UL, 0x89d32be0UL, 0x10da7a5aUL, 0x67dd4accUL,
 0xf9b9df6fUL, 0x8ebeeff9UL, 0x17b7be43UL, 0x60b08ed5UL,
 0xd6d6a3e8UL, 0xa1d1937eUL, 0x38d8c2c4UL, 0x4fdff252UL,
 0xd1bb67f1UL, 0xa6bc5767UL, 0x3fb506ddUL, 0x48b2364bUL,
 0xd80d2bdaUL, 0xaf0a1b4cUL, 0x36034af6UL, 0x41047a60UL,
 0xdf60efc3UL, 0xa867df55UL, 0x316e8eefUL, 0x4669be79UL,
 0xcb61b38cUL, 0xbc66831aUL, 0x256fd2a0UL, 0x5268e236UL,
 0xcc0c7795UL, 0xbb0b4703UL, 0x220216b9UL, 0x5505262fUL,
 0xc5ba3bbeUL, 0xb2bd0b28UL, 0x2bb45a92UL, 0x5cb36a04UL,
 0xc2d7ffa7UL, 0xb5d0cf31UL, 0x2cd99e8bUL, 0x5bdeae1dUL,
 0x9b64c2b0UL, 0xec63f226UL, 0x756aa39cUL, 0x026d930aUL,
 0x9c0906a9UL, 0xeb0e363fUL, 0x72076785UL, 0x05005713UL,
 0x95bf4a82UL, 0xe2b87a14UL, 0x7bb12baeUL, 0x0cb61b38UL,
 0x92d28e9bUL, 0xe5d5be0dUL, 0x7cdcefb7UL, 0x0bdbdf21UL,
 0x86d3d2d4UL, 0xf1d4e242UL, 0x68ddb3f8UL, 0x1fda836eUL,
 0x81be16cdUL, 0xf6b9265bUL, 0x6fb077e1UL, 0x18b74777UL,
 0x88085ae6UL, 0xff0f6a70UL, 0x66063bcaUL, 0x11010b5cUL,
 0x8f659effUL, 0xf862ae69UL, 0x616bffd3UL, 0x166ccf45UL,
 0xa00ae278UL, 0xd70dd2eeUL, 0x4e048354UL, 0x3903b3c2UL,
 0xa7672661UL, 0xd06016f7UL, 0x4969474dUL, 0x3e6e77dbUL,
 0xaed16a4aUL, 0xd9d65adcUL, 0x40df0b66UL, 0x37d83bf0UL,
 0xa9bcae53UL, 0xdebb9ec5UL, 0x47b2cf7fUL, 0x30b5ffe9UL,
 0xbdbdf21cUL, 0xcabac28aUL, 0x53b39330UL, 0x24b4a3a6UL,
 0xbad03605UL, 0xcdd70693UL, 0x54de5729UL, 0x23d967bfUL,
 0xb3667a2eUL, 0xc4614ab8UL, 0x5d681b02UL, 0x2a6f2b94UL,
 0xb40bbe37UL, 0xc30c8ea1UL, 0x5a05df1bUL, 0x2d02ef8dUL
};

static uint32_t crc32(const uint8_t *buf, size_t size)
{uint32_t i, crc;
 crc=0xFFFFFFFF;
 for(i=0;i<size;i++)
  crc=crc32tab[(crc^buf[i])&0xff]^(crc>>8);
 return(crc^0xFFFFFFFF);
}

JNIEXPORT jdoubleArray JNICALL Java_lucky_sayHello (JNIEnv *env, __attribute__((unused)) jobject thisObj,jlong qualified,jlong winTime,jlong auctionBeginTime)
 {
// tr -d % | awk '{print "    {"((18446744073709551616*$1)/100)"ULL,"((18446744073709551616*$2)/100)"ULL},"}' | sed -e 's/18446744073709551616/18446744073709551615/g' -e 's/1.84467e+15/1844674407370955/'

//uint64_t map1[4][12][2]=
uint64_t map1[96]=
 {
    2767011611056432640ULL,3135946492530624000ULL,
    3320413933267719168ULL,3504881374004814848ULL,
    3689348814741910528ULL,4058283696216101376ULL,
    4242751136953197056ULL,4427218577690292224ULL,
    4611686018427387904ULL,4980620899901579264ULL,
    5165088340638674944ULL,5349555781375769600ULL,
    5534023222112865280ULL,6087425544324152320ULL,
    6271892985061248000ULL,7194230188746725376ULL,
    7378697629483821056ULL,9407839477591871488ULL,
    9592306918328967168ULL,12359318529385400320ULL,
    12543785970122496000ULL,17524406870024073216ULL,
    18262276632972455936ULL,18446744073709551615ULL,
    4611686018427387904ULL,5165088340638674944ULL,
    5165088340638674944ULL,5718490662849960960ULL,
    5534023222112865280ULL,6087425544324152320ULL,
    6087425544324152320ULL,6825295307272534016ULL,
    6456360425798342656ULL,7932099951695107072ULL,
    7194230188746725376ULL,10145709240540254208ULL,
    8301034833169298432ULL,13097188292333780992ULL,
    10514644122014443520ULL,15495265021916022784ULL,
    15679732462653118464ULL,17339939429286977536ULL,
    17524406870024073216ULL,17708874310761168896ULL,
    17893341751498264576ULL,18077809192235360256ULL,
    18446744073709551615ULL,18446744073709551615ULL,
    9223372036854775808ULL,9961241799803158528ULL,
    10145709240540254208ULL,10883579003488634880ULL,
    11068046444225730560ULL,12174851088648304640ULL,
    12359318529385400320ULL,13650590614545068032ULL,
    13835058055282163712ULL,15679732462653118464ULL,
    15864199903390214144ULL,18077809192235360256ULL,
    18262276632972455936ULL,18280723377046165504ULL,
    18299170121119875072ULL,18317616865193584640ULL,
    18336063609267296256ULL,18354510353341003776ULL,
    18372957097414713344ULL,18391403841488422912ULL,
    18409850585562132480ULL,18428297329635844096ULL,
    18446744073709551615ULL,18446744073709551615ULL,
    0ULL,18446744073709552ULL,
    0ULL,18446744073709552ULL,
    0ULL,18446744073709552ULL,
    0ULL,18446744073709552ULL,
    0ULL,18446744073709552ULL,
    0ULL,18446744073709552ULL,
    0ULL,18446744073709552ULL,
    0ULL,18446744073709552ULL,
    0ULL,18446744073709552ULL,
    0ULL,18446744073709552ULL,
    0ULL,18446744073709552ULL,
    0ULL,18446744073709552ULL,
};
//uint64_t map0[4][22][2]=
uint64_t map0[176]=
 {
    1844674407370955ULL,18446744073709552ULL,
    20291418481080508ULL,36893488147419104ULL,
    38738162554790056ULL,55340232221128656ULL,
    57184906628499608ULL,73786976294838208ULL,
    75631650702209152ULL,92233720368547760ULL,
    94078394775918720ULL,110680464442257312ULL,
    112525138849628256ULL,129127208515966848ULL,
    130971882923337808ULL,147573952589676416ULL,
    149418626997047392ULL,166020696663385984ULL,
    167865371070756928ULL,184467440737095520ULL,
    186312115144466464ULL,368934881474191040ULL,
    370779555881561920ULL,553402322211286528ULL,
    555246996618657472ULL,737869762948382080ULL,
    739714437355752960ULL,922337203685477632ULL,
    924181878092848512ULL,1106804644422573056ULL,
    1108649318829944064ULL,1291272085159668736ULL,
    1293116759567039488ULL,1475739525896764160ULL,
    1477584200304135168ULL,1660206966633859584ULL,
    1662051641041230592ULL,1844674407370955264ULL,
    1846519081778326016ULL,2029141848108050688ULL,
    2030986522515421696ULL,2213609288845146112ULL,
    2215453963252517120ULL,2398076729582241792ULL,
    55340232221128656ULL,71942301887467256ULL,
    73786976294838208ULL,90389045961176800ULL,
    92233720368547760ULL,108835790034886352ULL,
    110680464442257312ULL,127282534108595904ULL,
    129127208515966848ULL,145729278182305472ULL,
    147573952589676416ULL,164176022256015008ULL,
    166020696663385984ULL,182622766329724544ULL,
    184467440737095520ULL,367090207066820096ULL,
    368934881474191040ULL,551557647803915648ULL,
    553402322211286528ULL,736025088541011200ULL,
    737869762948382080ULL,920492529278106624ULL,
    922337203685477632ULL,1104959970015202176ULL,
    1106804644422573056ULL,1289427410752297728ULL,
    1291272085159668736ULL,1473894851489393152ULL,
    1475739525896764160ULL,1658362292226488832ULL,
    1660206966633859584ULL,1842829732963584256ULL,
    1844674407370955264ULL,2027297173700679680ULL,
    2029141848108050688ULL,2211764614437775360ULL,
    2213609288845146112ULL,2396232055174871040ULL,
    2398076729582241792ULL,2451572287395999232ULL,
    2453416961803370496ULL,2506912519617127936ULL,
    2508757194024499200ULL,2562252751838256640ULL,
    110680464442257312ULL,127282534108595904ULL,
    129127208515966848ULL,145729278182305472ULL,
    147573952589676416ULL,164176022256015008ULL,
    166020696663385984ULL,182622766329724544ULL,
    184467440737095520ULL,201069510403434112ULL,
    368934881474191040ULL,385536951140529600ULL,
    553402322211286528ULL,570004391877625088ULL,
    737869762948382080ULL,920492529278106624ULL,
    922337203685477632ULL,1104959970015202176ULL,
    1106804644422573056ULL,1289427410752297728ULL,
    1291272085159668736ULL,1473894851489393152ULL,
    1475739525896764160ULL,1658362292226488832ULL,
    1660206966633859584ULL,1842829732963584256ULL,
    1844674407370955264ULL,2027297173700679680ULL,
    2029141848108050688ULL,2211764614437775360ULL,
    2213609288845146112ULL,2396232055174871040ULL,
    2398076729582241792ULL,2580699495911966208ULL,
    2582544170319337472ULL,2617592984059385344ULL,
    2619437658466756096ULL,2654486472206804480ULL,
    2656331146614175744ULL,2691379960354223616ULL,
    2693224634761594368ULL,2728273448501642752ULL,
    2730118122909014016ULL,2765166936649061888ULL,
    92233720368547760ULL,166020696663385984ULL,
    184467440737095520ULL,221360928884514624ULL,
    239807672958224192ULL,258254417031933696ULL,
    276701161105643264ULL,295147905179352832ULL,
    313594649253062400ULL,350488137400481472ULL,
    368934881474191040ULL,1014570924054025344ULL,
    1033017668127734784ULL,1752440687002407424ULL,
    1770887431076116992ULL,3043712772162076160ULL,
    2877692075498690048ULL,3781582535110457856ULL,
    3984496719921263616ULL,5072854620270127104ULL,
    5091301364343836672ULL,6548594146166890496ULL,
    6567040890240601088ULL,8393268553537846272ULL,
    8411715297611555840ULL,10053475520171706368ULL,
    10071922264245415936ULL,10975812723857182720ULL,
    10994259467930892288ULL,11898149927542661120ULL,
    11916596671616368640ULL,12820487131228137472ULL,
    12838933875301847040ULL,13742824334913615872ULL,
    13761271078987325440ULL,14665161538599094272ULL,
    14683608282672801792ULL,15587498742284570624ULL,
    15605945486358280192ULL,16509835945970049024ULL,
    16528282690043756544ULL,17432173149655525376ULL,
    17450619893729234944ULL,18262276632972455936ULL,
};

  const size_t n=4;
  assert(8==sizeof(uint64_t) && 8==sizeof(jlong));
  //const int32_t beginTime=(qualified?winTime:auctionBeginTime);
  jdoubleArray out = (*env)->NewDoubleArray(env, n);
  if(NULL==out)
   {fprintf(stderr,"Out of Memo1y!");
   }
  else
   {
    //fprintf(stderr,"%08lX %08lX %08lX %08lX %08lX\n",*((uint64_t*)&qualified),*((uint64_t*)&winTime ),*((uint64_t*)&auctionBeginTime), *((uint64_t*)&qualified)^*((uint64_t*)&winTime ), *((uint64_t*)&winTime )^*((uint64_t*)&auctionBeginTime));
    if((*(1+(uint32_t*)&qualified))!=crc32((uint8_t*)&qualified,4))
     {fprintf(stderr,"Out of Memo2y!");
     }
    else
     {
      uint64_t e=(qualified^winTime);
      //fprintf(stderr,"%08lX %04X\n",e,crc32((uint8_t*)&e,4));
      if((*(1+(uint32_t*)&e))!=crc32((uint8_t*)&e,4))
       {fprintf(stderr,"Out of Memo3y!");
       }
      else
       {auctionBeginTime=(winTime^auctionBeginTime);
        if((*(1+(uint32_t*)&auctionBeginTime))!=crc32((uint8_t*)&auctionBeginTime,4))
         {fprintf(stderr,"Out of Memo4y!");
         }
        else
         {winTime=((0x1FFFFFFFUL&e)/67)*37*67;
          auctionBeginTime=((0x3FFFFFFFUL&auctionBeginTime)/37)*67*37;
          qualified&=0x0000000000000008ULL;
          //fprintf(stderr,"%08lX %08lX %08lX %ld %ld %ld\n",*((uint64_t*)&qualified),*((uint64_t*)&winTime ),*((uint64_t*)&auctionBeginTime),*((uint64_t*)&winTime ),*((uint64_t*)&auctionBeginTime),winTime-auctionBeginTime);
          //if((37*67+auctionBeginTime)!=winTime)
          if(auctionBeginTime>winTime)
           {fprintf(stderr,"Out of Memo5y!");
           }
          else
           {
            e=time(NULL);
            if(e<(uint64_t)auctionBeginTime)
             {fprintf(stderr,"Out of Memo6y!");
             }
            else
             {
              jdouble j[n];
              uint64_t buf[n];
              uint8_t i;
              for(i=0;i<n;i++)
               {assert(1==RAND_bytes((unsigned char *)&(buf[i]),sizeof(buf[0])));
                // t=0ULL; // 0.0
                // t=1ULL; // 5.421010862427522E-20
                // t=18446744073709550591ULL; // 0.9999999999999999
                // t=18446744073709550592ULL; // 1.0
                // t=18446744073709551615ULL; // 1.0
               }

              uint8_t m;
              uint64_t *p;
              switch(qualified)
               {case 0:
                 p=&(map0[0]);
                 m=sizeof(map0)/(sizeof(map0[0])*4*2);
                 break;
                case 8:
                 p=&(map1[0]);
                 m=sizeof(map1)/(sizeof(map1[0])*4*2);
                 break;
                default:
                 m=0;
                 p=NULL;
                 fprintf(stderr,"Out of Memo5y!");
               }
              if(0!=m)
               {e=(e-auctionBeginTime)/(60*60*24*30);
                if(m<=1+e)
                 {e=m-1;
                 }
                for(i=0;i<n;i++)
                 {j[i]=(((double)buf[i])/UINT64_MAX*(p[((i*m)+e)*2+1]-p[((i*m)+e)*2+0])+p[((i*m)+e)*2+0])/UINT64_MAX;
                  //fprintf(stderr,"%lu %ld %lf %lf %lf\n",(uint64_t)qualified,e,100*((double)p[((i*m)+e)*2+0])/UINT64_MAX,100*j[i],100*((double)p[((i*m)+e)*2+1])/UINT64_MAX);
                 }
                (*env)->SetDoubleArrayRegion(env, out, 0, n, j);
               }
             }
           }
         }
       }
     }
   }
  return(out);
 }
